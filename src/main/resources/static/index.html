<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal ONG Sementes do Amanhã</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <style>
        /* --- 2. ESTILOS PERSONALIZADOS (CSS) --- */
        
        /* Define a cor de fundo padrão e a fonte do sistema */
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-top: 70px; }
        
        /* Utilitário para esconder elementos antes do JavaScript carregar (evita piscar) */
        [x-cloak] { display: none !important; }
        .cursor-pointer { cursor: pointer; }

        /* PALETA DE CORES (Tema Azul Oceano) */
        :root { 
            --primary: #0f4c75; /* Azul Profundo (Identidade da ONG) */
            --accent: #3282b8;  /* Azul Médio (Destaques) */
        }
        
        /* Classes utilitárias para usar as cores acima */
        .bg-ong { background-color: var(--primary); }
        .text-ong { color: var(--primary); }
        
        /* Estilização dos Botões Principais */
        .btn-ong { background-color: var(--primary); color: white; border: none; }
        .btn-ong:hover { background-color: #0b3857; color: white; } /* Efeito ao passar o mouse */
        
        /* Estilo da Logo (Redonda e com borda branca) */
        .ong-logo { height: 40px; margin-right: 10px; background: white; border-radius: 50%; padding: 2px; }
        
        /* Estilo dos Cards do Painel (Dashboard) */
        .stat-card { border: none; border-radius: 12px; padding: 20px; color: white; position: relative; overflow: hidden; }
        
        /* Gradientes para os Cards de Estatística */
        .bg-grad-1 { background: linear-gradient(45deg, #0f4c75, #3282b8); } /* Azul */
        .bg-grad-2 { background: linear-gradient(45deg, #ff9f1a, #ffc107); } /* Amarelo */
        .bg-grad-3 { background: linear-gradient(45deg, #20bf6b, #26de81); } /* Verde */
        
        /* Foto de Perfil Redonda */
        .profile-avatar { width: 150px; height: 150px; object-fit: cover; border: 5px solid white; border-radius: 50%; background: #ddd; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        /* Correção para Links agirem como Botões */
        .nav-link-custom { cursor: pointer; text-decoration: none; z-index: 1050; position: relative; }
        .nav-link-custom:hover { text-decoration: underline; }
        
        /* Navbar Superior Fixa (Azul Escuro) */
        .navbar-custom { background-color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        /* Links do Menu Superior */
        .nav-link { color: rgba(255,255,255,0.9) !important; font-weight: 500; margin: 0 5px; }
        .nav-link:hover, .nav-link.active { color: white !important; font-weight: bold; }
    </style>

    <script>
        function sys() {
            return {
                // --- ESTADO GLOBAL DA APLICAÇÃO ---
                view: 'home', // Define qual tela o usuário está vendo agora
                token: localStorage.getItem('token'), // Guarda o token de login
                user: {}, // Guarda dados do usuário logado
                extraData: {}, // Guarda dados extras do perfil (visual)
                isAdmin: false, // Define se o usuário é Chefe ou Voluntário
                
                // --- DADOS DOS FORMULÁRIOS ---
                form: { username: '', password: '', adminCode: '' }, // Login/Cadastro
                profileForm: { name: '', email: '', phone: '', address: '', bio: '', photoUrl: '' }, // Edição de Perfil
                newUserForm: { username: '', password: '', role: 'USER' }, // Novo usuário (Admin)
                
                // Formulário de Doação (Com Logística)
                formDoacao: { descricao: '', quantidade: '', destino: '' },
                
                // Controles de Interface
                editingProfile: false, // Se está editando perfil
                modalUser: false, // Se o modal de admin está aberto
                list: [], // Lista de doações
                usersList: [], // Lista de equipe
                toast: { show: false, msg: '', type: 'success' }, // Notificação flutuante
                
                logoSrc: 'https://cdn-icons-png.flaticon.com/512/1598/1598196.png', // Imagem da Logo

                // --- INICIALIZAÇÃO (Roda ao abrir o site) ---
                init() {
                    // Tenta recuperar usuário salvo na memória
                    try { this.user = JSON.parse(localStorage.getItem('user')) || {}; } catch (e) { this.user = {}; }
                    this.loadExtraData(); // Carrega perfil visual
                    
                    // Se já tiver token, vai direto pro Painel
                    if(this.token) {
                        this.isAdmin = (this.user.role === 'ADMIN');
                        this.view = 'dashboard';
                        this.fetchAll();
                    }
                },

                // Função auxiliar para exibir o cargo de forma amigável
                getRoleLabel() {
                    return this.isAdmin ? 'Coordenador' : 'Voluntário';
                },

                // --- GERENCIAMENTO DE PERFIL (LOCALSTORAGE) ---
                loadExtraData() {
                    const key = `profile_${this.user.username || 'guest'}`;
                    const stored = localStorage.getItem(key);
                    // Se tiver perfil salvo, usa. Senão, usa dados padrão.
                    this.extraData = stored ? JSON.parse(stored) : { name: this.user.username || 'Voluntário', email: 'email@teste.com', phone: '-', address: '-', bio: 'Colaborador.', photoUrl: '' };
                },
                openEditProfile() { this.profileForm = { ...this.extraData }; this.editingProfile = true; },
                saveProfileLocal() {
                    // Salva alterações de perfil no navegador
                    this.extraData = { ...this.profileForm };
                    localStorage.setItem(`profile_${this.user.username}`, JSON.stringify(this.extraData));
                    this.editingProfile = false;
                    this.notify('Salvo com sucesso!', 'success');
                },

                // --- NAVEGAÇÃO ---
                navigate(to) { this.view = to; },

                // --- COMUNICAÇÃO COM O BACKEND (JAVA) ---
                async req(url, method = 'GET', body = null) {
                    const opts = { method, headers: { 'Content-Type': 'application/json' } };
                    // Adiciona Token no cabeçalho para segurança
                    if (this.token) opts.headers['Authorization'] = this.token;
                    if (body) opts.body = JSON.stringify(body);
                    
                    const res = await fetch('/api' + url, opts);
                    
                    // Se o token expirou (401), desloga
                    if (res.status === 401) { this.logout(); return null; }
                    return res;
                },

                // --- AUTENTICAÇÃO ---
                async login() {
                    const res = await fetch('/login', { method: 'POST', body: JSON.stringify(this.form) });
                    if(res && res.ok) {
                        const data = await res.json();
                        this.token = data.token;
                        this.user = { username: data.username, role: data.role, id: data.id };
                        this.isAdmin = (data.role === 'ADMIN'); // Define permissão
                        
                        // Salva sessão
                        localStorage.setItem('token', this.token);
                        localStorage.setItem('user', JSON.stringify(this.user));
                        
                        this.loadExtraData();
                        this.form = { username: '', password: '', adminCode: '' };
                        this.view = 'dashboard';
                        this.fetchAll();
                    } else this.notify('Login incorreto', 'danger');
                },
                
                async register() {
                    // Envia código admin junto (se houver)
                    const res = await fetch('/signup', { method: 'POST', body: JSON.stringify(this.form) });
                    if(res && res.ok) { this.notify('Cadastrado! Faça Login.', 'success'); this.view = 'login'; } 
                    else this.notify('Erro ao cadastrar.', 'warning');
                },
                
                logout() { this.token = null; localStorage.clear(); this.view = 'home'; },
                
                // --- CRUD DOAÇÕES ---
                async fetchAll() {
                    if(!this.token) return;
                    // Admin vê tudo, Voluntário vê só dele
                    const url = this.isAdmin ? '/admin/doacoes' : '/doacoes';
                    const res = await this.req(url);
                    if(res && res.ok) this.list = await res.json();
                },
                
                async addDoacao() {
                    if(!this.formDoacao.descricao) return this.notify("Preencha a descrição.", "warning");
                    // Envia os 3 campos (Logística)
                    const res = await this.req('/doacoes', 'POST', this.formDoacao);
                    if(res && res.ok) { 
                        this.formDoacao = { descricao: '', quantidade: '', destino: '' }; // Limpa form
                        this.notify('Registrado!', 'success'); 
                        if(!this.isAdmin) this.view = 'dashboard'; 
                        this.fetchAll(); 
                    }
                },
                
                async toggleStatus(item) {
                    item.recebido = !item.recebido;
                    await this.req(`/doacoes/${item.id}`, 'PUT', item);
                    this.notify('Atualizado!', 'success');
                },
                
                async deleteDoacao(id) {
                    if(confirm("Apagar?")) { await this.req(`/doacoes/${id}`, 'DELETE'); this.fetchAll(); }
                },
                
                // --- ADMINISTRAÇÃO (USUÁRIOS) ---
                async fetchUsers() { const res = await this.req('/admin/users'); if(res && res.ok) this.usersList = await res.json(); },
                async createUser() { const res = await this.req('/admin/users', 'POST', this.newUserForm); if(res && res.ok) { this.modalUser = false; this.fetchUsers(); this.notify('Criado!', 'success'); } },
                async deleteUser(u) { if(confirm("Remover?")) { await this.req(`/admin/users/${u}`, 'DELETE'); this.fetchUsers(); } },
                
                // Notificação (Toast)
                notify(msg, type) {
                    this.toast = { show: true, msg, type };
                    setTimeout(() => this.toast.show = false, 3000);
                }
            }
        }
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
</head>
<body class="bg-light">

<div x-data="sys()" x-init="init()">

    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom fixed-top" style="background-color: #0f4c75;">
        <div class="container">
            <a class="navbar-brand fw-bold d-flex align-items-center cursor-pointer" @click="view='home'">
                <img :src="logoSrc" class="ong-logo"> Sementes do Amanhã
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain"><span class="navbar-toggler-icon"></span></button>
            
            <div class="collapse navbar-collapse" id="navbarMain">
                <ul class="navbar-nav ms-auto align-items-center gap-2">
                    
                    <template x-if="!token">
                        <div class="d-flex gap-2 align-items-center">
                            <a class="nav-link cursor-pointer" @click="view='home'">Início</a>
                            <a class="nav-link cursor-pointer" @click="view='about'">Sobre</a>
                            <a class="nav-link cursor-pointer fw-bold" @click="view='register'">Cadastre-se</a>
                            <button class="btn btn-light text-ong btn-sm px-3 fw-bold" @click="view='login'">Login</button>
                        </div>
                    </template>

                    <template x-if="token">
                        <div class="d-flex gap-2 align-items-center">
                            <a class="nav-link cursor-pointer" @click="view='dashboard'; fetchAll()">Painel</a>
                            <a class="nav-link cursor-pointer" @click="view='profile'">Perfil</a>
                            <template x-if="isAdmin"><a class="nav-link cursor-pointer text-warning" @click="view='admin_users'; fetchUsers()">Equipe</a></template>
                            <button class="btn btn-outline-light btn-sm" @click="logout()">Sair</button>
                        </div>
                    </template>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        
        <div x-show="view === 'home'" class="text-center py-5">
            <h1 class="display-4 fw-bold text-ong mb-3">Juntos Somos Mais Fortes</h1>
            <p class="lead text-muted mb-5">Plataforma oficial de gestão de doações e voluntariado.</p>
            <div class="row justify-content-center g-4">
                <div class="col-md-4"><div class="p-4 bg-white shadow-sm rounded-4"><i class="bi bi-shield-check display-4 text-ong"></i><h5 class="mt-3">Segurança</h5></div></div>
                <div class="col-md-4"><div class="p-4 bg-white shadow-sm rounded-4"><i class="bi bi-heart-fill display-4 text-ong"></i><h5 class="mt-3">Solidariedade</h5></div></div>
                <div class="col-md-4"><div class="p-4 bg-white shadow-sm rounded-4"><i class="bi bi-graph-up-arrow display-4 text-ong"></i><h5 class="mt-3">Transparência</h5></div></div>
            </div>
        </div>

        <div x-show="view === 'about'" class="py-5">
            <h2 class="text-ong fw-bold mb-4">Sobre a ONG</h2>
            <div class="bg-white p-5 shadow-sm rounded-4"><p class="fs-5 text-secondary">A Sementes do Amanhã atua combatendo a insegurança alimentar e apoiando famílias em vulnerabilidade.</p></div>
        </div>

        <div x-show="view === 'login'" class="row justify-content-center">
            <div class="col-md-4"><div class="card border-0 shadow-lg p-4 rounded-4"><div class="card-body">
                <div class="mb-4"><a class="nav-link-custom text-ong fw-bold" @click.prevent="navigate('home')"><i class="bi bi-arrow-left"></i> Voltar</a></div>
                <h3 class="text-center text-ong fw-bold mb-4">Acesso</h3>
                <form @submit.prevent="login">
                    <div class="mb-3"><input x-model="form.username" class="form-control" placeholder="Usuário" required></div>
                    <div class="mb-3"><input type="password" x-model="form.password" class="form-control" placeholder="Senha" required></div>
                    <button class="btn btn-ong w-100 rounded-pill fw-bold">ENTRAR</button>
                </form>
                <div class="text-center mt-4"><a class="nav-link-custom text-muted small fw-bold" @click.prevent="view='register'">Não tem conta? Cadastre-se</a></div>
            </div></div></div>
        </div>

        <div x-show="view === 'register'" class="row justify-content-center">
            <div class="col-md-5"><div class="card border-0 shadow-lg p-4 rounded-4"><div class="card-body">
                <div class="mb-4"><a class="nav-link-custom text-ong fw-bold" @click.prevent="navigate('home')"><i class="bi bi-house"></i> Início</a></div>
                <h3 class="text-center text-ong fw-bold mb-4">Novo Voluntário</h3>
                <form @submit.prevent="register">
                    <div class="mb-3"><label class="small fw-bold">Usuário</label><input x-model="form.username" class="form-control" required></div>
                    <div class="mb-3"><label class="small fw-bold">Senha</label><input type="password" x-model="form.password" class="form-control" required></div>
                    <div class="mb-4"><label class="small fw-bold text-muted">Cód. Admin (Opcional)</label><input type="password" x-model="form.adminCode" class="form-control"></div>
                    <button class="btn btn-ong w-100 rounded-pill fw-bold">CRIAR CONTA</button>
                </form>
                <div class="text-center mt-4"><a class="nav-link-custom text-ong small fw-bold" @click.prevent="navigate('login')">Já tenho cadastro</a></div>
            </div></div></div>
        </div>

        <div x-show="view === 'dashboard'">
            <div class="row g-4 mb-4">
                <div class="col-md-4"><div class="stat-card bg-grad-1"><h6>Total</h6><h3 x-text="list.length">0</h3></div></div>
                <div class="col-md-4"><div class="stat-card bg-grad-2"><h6>Pendentes</h6><h3 x-text="list.filter(x => !x.recebido).length">0</h3></div></div>
                <div class="col-md-4"><div class="stat-card bg-grad-3"><h6>Entregues</h6><h3 x-text="list.filter(x => x.recebido).length">0</h3></div></div>
            </div>
            
            <template x-if="!isAdmin">
                <div class="card border-0 shadow-sm mb-4 p-4">
                    <h5 class="text-ong fw-bold mb-3">Registrar Doação</h5>
                    <div class="row g-2">
                        <div class="col-md-6"><input type="text" class="form-control" placeholder="O que foi doado? (Ex: Arroz)" x-model="formDoacao.descricao"></div>
                        <div class="col-md-3"><input type="text" class="form-control" placeholder="Qtd (Ex: 5kg)" x-model="formDoacao.quantidade"></div>
                        <div class="col-md-3"><select class="form-select" x-model="formDoacao.destino"><option value="">Destino...</option><option value="Sede">Sede</option><option value="Família">Família</option></select></div>
                        <div class="col-12 text-end mt-2"><button class="btn btn-ong px-5 fw-bold" @click="addDoacao()">SALVAR</button></div>
                    </div>
                </div>
            </template>

            <div class="card border-0 shadow-sm">
                <table class="table align-middle mb-0">
                    <thead class="table-light"><tr><th class="ps-4">Item / Detalhes</th><th>Status</th><th class="text-end pe-4">Ação</th></tr></thead>
                    <tbody>
                        <template x-for="d in list" :key="d.id">
                            <tr>
                                <td class="ps-4">
                                    <div><span class="fw-bold text-dark" x-text="d.descricao"></span>
                                    <div class="small text-muted">Qtd: <span x-text="d.quantidade || '-'"></span> | Destino: <span x-text="d.destino || '-'"></span></div></div>
                                </td>
                                <td><span class="badge rounded-pill" :class="d.recebido?'bg-success':'bg-warning text-dark'" x-text="d.recebido?'Recebido':'Pendente'"></span></td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-success me-1" @click="toggleStatus(d)" x-show="isAdmin" title="Confirmar"><i class="bi bi-check-lg"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteDoacao(d.id)" x-show="isAdmin || !d.recebido"><i class="bi bi-trash"></i></button>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="list.length===0"><td colspan="3" class="text-center py-4 text-muted">Nenhum registro.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div x-show="view === 'profile'" class="text-center">
            <div class="bg-white p-5 shadow rounded-4 d-inline-block" style="max-width: 600px; width: 100%;">
                <img :src="extraData.photoUrl || 'https://ui-avatars.com/api/?name='+user.username+'&background=0f4c75&color=fff'" class="profile-avatar mb-3">
                <h2 x-text="extraData.name" class="fw-bold text-ong"></h2>
                <p class="badge bg-secondary" x-text="getRoleLabel()"></p>
                <p class="text-muted mt-2" x-text="extraData.address"></p>
                <hr>
                <div x-show="!editingProfile">
                    <p x-text="extraData.bio" class="fst-italic text-muted"></p>
                    <button class="btn btn-outline-primary rounded-pill px-4 mt-3" @click="openEditProfile()">Editar Perfil</button>
                </div>
                <div x-show="editingProfile" class="text-start">
                    <label class="small fw-bold">Nome</label><input x-model="profileForm.name" class="form-control mb-2">
                    <label class="small fw-bold">Endereço</label><input x-model="profileForm.address" class="form-control mb-2">
                    <label class="small fw-bold">Bio</label><textarea x-model="profileForm.bio" class="form-control mb-3"></textarea>
                    <div class="text-center"><button class="btn btn-success rounded-pill px-4" @click="saveProfileLocal()">Salvar</button></div>
                </div>
            </div>
        </div>

        <div x-show="isAdmin && view === 'admin_users'">
            <div class="d-flex justify-content-between mb-3"><h4 class="text-ong">Equipe</h4><button class="btn btn-ong btn-sm rounded-pill" @click="modalUser=true">+ Novo</button></div><div class="card border-0 shadow-sm"><table class="table mb-0"><thead class="table-light"><tr><th class="ps-4">Usuário</th><th>Cargo</th><th class="text-end pe-4">Ação</th></tr></thead><tbody><template x-for="u in usersList" :key="u.id"><tr><td class="ps-4 fw-bold" x-text="u.username"></td><td><span class="badge" :class="u.role==='ADMIN'?'bg-danger':'bg-primary'" x-text="u.role"></span></td><td class="text-end pe-4"><button class="btn btn-sm text-danger" @click="deleteUser(u.username)" :disabled="u.username===user.username"><i class="bi bi-x-lg"></i></button></td></tr></template></tbody></table></div>
        </div>
    </div>

    <div x-show="modalUser" class="modal fade" :class="{ 'show d-block': modalUser }" style="background: rgba(0,0,0,0.5)"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 shadow rounded-4"><div class="modal-header bg-ong text-white"><h5 class="modal-title">Novo Membro</h5><button type="button" class="btn-close btn-close-white" @click="modalUser=false"></button></div><div class="modal-body p-4"><input x-model="newUserForm.username" class="form-control mb-3" placeholder="Nome"><input type="password" x-model="newUserForm.password" class="form-control mb-3" placeholder="Senha"><select x-model="newUserForm.role" class="form-select mb-4"><option value="USER">Voluntário</option><option value="ADMIN">Coordenador</option></select><button class="btn btn-ong w-100 rounded-pill" @click="createUser()">Salvar</button></div></div></div></div>
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999"><div x-show="toast.show" class="toast show align-items-center text-white border-0 shadow" :class="'bg-' + toast.type"><div class="d-flex p-2 px-3"><div class="toast-body fw-bold" x-text="toast.msg"></div></div></div></div>
</div>
</body>
</html>